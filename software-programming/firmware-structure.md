# ЁЯПЧя╕П Firmware Structure & Finite State Machine

> р╣Вр╕Др╣Йр╕Фр╕Чр╕╡р╣И "р╕Чр╕│р╕Зр╕▓р╕Щр╣Др╕Фр╣Й" р╕Бр╕▒р╕Ъ р╣Вр╕Др╣Йр╕Фр╕Чр╕╡р╣И "р╕Фр╕╡" р╕Хр╣Ир╕▓р╕Зр╕Бр╕▒р╕Щр╕Чр╕╡р╣И **"р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕З"** р╣Вр╕Др╣Йр╕Фр╕Чр╕╡р╣Ир╕Фр╕╡р╕Хр╣Йр╕нр╕Зр╣Бр╕Бр╣Йр╣Др╕Вр╕Зр╣Ир╕▓р╕в р╣Бр╕ер╕░р╣Ар╕гр╕▓р╕гр╕╣р╣Йр╣Ар╕кр╕бр╕нр╕зр╣Ир╕▓р╕Хр╕нр╕Щр╕Щр╕╡р╣Йр╕гр╕░р╕Ър╕Ър╕Бр╕│р╕ер╕▒р╕Зр╕Чр╕│р╕нр╕░р╣Др╕гр╕нр╕вр╕╣р╣И

---

## 1. Finite State Machine (FSM)

р╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕Ир╕▒р╕Бр╕гр╣Гр╕Щр╣Вр╕гр╕Зр╕Зр╕▓р╕Щр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Чр╕│р╕Зр╕▓р╕Щр╕бр╕▒р╣Ир╕зр╣Ж р╣Бр╕Хр╣Ир╕бр╕▒р╕Щр╕бр╕╡ "р╕кр╕Цр╕▓р╕Щр╕░" р╕Чр╕╡р╣Ир╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ FSM р╕Кр╣Ир╕зр╕вр╕Бр╕│р╕Ир╕▒р╕Фр╕Ър╕▒р╣Кр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Ч "р╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕Чр╕│р╕Зр╕▓р╕Щр╕Лр╣Йр╕нр╕Щр╕Бр╕▒р╕Щ"

### Diagram: Washing Machine Logic

```mermaid
stateDiagram-v2
    [*] --> IDLE
    IDLE --> FILL_WATER : Press Start
    FILL_WATER --> WASH : Water Full
    WASH --> DRAIN : Timer End
    DRAIN --> SPIN : Water Empty
    SPIN --> IDLE : Timer End
    
    state WASH {
        [*] --> MotorLeft
        MotorLeft --> MotorRight
    }

```

### р╕Бр╕▓р╕гр╣Ар╕Вр╕╡р╕вр╕Щ FSM р╕Фр╣Йр╕зр╕в Switch-Case

```cpp
enum State { IDLE, FILL_WATER, WASH, ERROR };
State currentState = IDLE;

void runMachine() {
  switch (currentState) {
    case IDLE:
      if (btnStart) currentState = FILL_WATER;
      break;
    case FILL_WATER:
      openValve();
      if (waterFull) currentState = WASH;
      break;
    // ...
  }
}

```

---

## 2. Modular Programming

р╕нр╕вр╣Ир╕▓р╣Ар╕Вр╕╡р╕вр╕Щр╕Чр╕╕р╕Бр╕нр╕вр╣Ир╕▓р╕Зр╣Гр╕Щр╣Др╕Яр╕ер╣Мр╣Ар╕Фр╕╡р╕вр╕з (`main.cpp` р╕вр╕▓р╕з 5000 р╕Ър╕гр╕гр╕Чр╕▒р╕Ф = р╕Щр╕гр╕Б)
р╣Гр╕лр╣Йр╣Бр╕вр╕Бр╣Др╕Яр╕ер╣Мр╕Хр╕▓р╕бр╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣И:

* `sensor_manager.cpp` / `.h` -> р╕Фр╕╣р╣Бр╕ер╕Бр╕▓р╕гр╕нр╣Ир╕▓р╕Щр╕Др╣Ир╕▓ Sensor
* `wifi_manager.cpp` / `.h` -> р╕Фр╕╣р╣Бр╕ер╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╣Бр╕ер╕░ Reconnect
* `mqtt_manager.cpp` / `.h` -> р╕Фр╕╣р╣Бр╕ер╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е

---

## 3. OTA (Over-The-Air) Updates

р╕Яр╕╡р╣Ар╕Ир╕нр╕гр╣Мр╣Др╕бр╣Йр╕Хр╕▓р╕вр╕Вр╕нр╕З IoT р╕Др╕╖р╕нр╕Бр╕▓р╕гр╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╣Ар╕Яр╕┤р╕гр╣Мр╕бр╣Бр╕зр╕гр╣Мр╣Др╕Фр╣Йр╣Вр╕Фр╕вр╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╣Др╕Ыр╕лр╕Щр╣Йр╕▓р╕Зр╕▓р╕Щ

* **Concept:** р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣М `.bin` р╣Гр╕лр╕бр╣Ир╕Ир╕▓р╕Б Server -> р╣Ар╕Бр╣Зр╕Ър╕ер╕З Partition р╕зр╣Ир╕▓р╕З -> р╕кр╕ер╕▒р╕Ъ Partition -> Reboot
* **Tools:** ArduinoOTA (р╣Гр╕Щр╕зр╕З LAN), AWS IoT Jobs (р╕Ьр╣Ир╕▓р╕Щ Cloud)

---

[ЁЯФЩ р╕Бр╕ер╕▒р╕Ър╕кр╕╣р╣Ир╕лр╕Щр╣Йр╕▓ Software](./README.md)
